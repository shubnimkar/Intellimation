pipeline {
    agent any
    
    environment {
        PASSWORD = credentials('windows-key') //Windows password is stored in Jenkins credentials replace name with your credentials id.
        WINDOWS_HOST = '172.32.0.141' // Replace this with your Windows machine IP or hostname
        WINDOWS_USERNAME = 'dc.support' // Replace this with your Windows username
        SCRIPT_START = "\\\\imslprad02\\backup\\Area51\\ftpdownload\\Jenkins\\Application_deployment\\Application_folder\\starthttpd.bat" // Replace with start script location
        SCRIPT_STOP = "\\\\imslprad02\\backup\\Area51\\ftpdownload\\Jenkins\\Application_deployment\\Application_folder\\stophttpd.bat" // Replace with Stop script location
        SCRIPT_STATUS = "\\\\imslprad02\\backup\\Area51\\ftpdownload\\Jenkins\\Application_deployment\\Application_folder\\status.bat" // Replace with Status script location
        SCRIPT_SEG = "\\\\imslprad02\\backup\\Area51\\ftpdownload\\Jenkins\\Application_deployment\\Backups\\segregation.bat" // Replace with backup file segregation script location
        SHARED_FOLDER = "\\\\imslprad02\\backup\\Area51\\ftpdownload\\Jenkins\\Application_deployment" // Location of shared folder
        NEXUS_URL = "https://github.com/shubnimkar/Intellimation/archive/refs/heads/master.zip" //Your Nexus URL
    }

    stages{
        
        //This will clean workspace
        
        stage('Clean Workspace'){
            steps{
                cleanWs()
            }
        }
        
        stage('Copy sshpass'){
        
        // This Stage is not required if you have sshpass installed on your jenkins machine, if not then implement this.
        
            steps{
                sh "cp /var/jenkins_home/sshpass /var/jenkins_home/workspace/Application-Rollback"
            }
        }
        
        stage('Status of Service') {
        
        	//This stage will show status of service which we have defined in script
        	// sshpass utility will be parsing the password to access windows machine
        	// We are using path for status script stored in environment variables
        	
            steps {
                script {
                     sh" ./sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $WINDOWS_USERNAME@$WINDOWS_HOST 'cmd /c $SCRIPT_STATUS'"
      
                }
            }
        }
        
        
        stage('Stop Service') {
        
        	//This stage will stop service which we have defined in script
        	// sshpass utility will be parsing the password to access windows machine
        	// We are using path for stop script stored in environment variables
        	
            steps {
                script {
                     sh" ./sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $WINDOWS_USERNAME@$WINDOWS_HOST 'cmd /c $SCRIPT_STOP'"
      
                }
            }
        }
        
        stage('Restoring to Application folder'){
        
        	//Here we are running script in first to segregate latest folder from our backup folders based on timestamp
        	//In second part we are parsing the name of latest folder to backup from it to application folder
        	
            steps{
                script{
                  def outputFromFirstCommand = sh(script: " ./sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $WINDOWS_USERNAME@$WINDOWS_HOST 'cmd /c $SCRIPT_SEG'", returnStdout: true).trim()
                  sh "./sshpass -p ${PASSWORD} ssh ${WINDOWS_USERNAME}@${WINDOWS_HOST} 'net use Z: $SHARED_FOLDER && copy Z:\\Backups\\${outputFromFirstCommand} Z:\\Application_folder  && Z: /delete ' "

                }
            }
        }
        
        stage('Start Service') {
        
        	//This stage will start service which we have defined in script
        	// sshpass utility will be parsing the password to access windows machine
        	// We are using path for start script stored in environment variables
        	
            steps {
                script {
                     sh" ./sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $WINDOWS_USERNAME@$WINDOWS_HOST 'cmd /c $SCRIPT_START'"
      
                }
            }
        }
        
        stage('Status ') {
        
        	//This stage will show status of service which we have defined in script	
        	// sshpass utility will be parsing the password to access windows machine
        	// We are using path for status script stored in environment variables
        	
            steps {
                script {
                     sh" ./sshpass -p $PASSWORD ssh -o StrictHostKeyChecking=no $WINDOWS_USERNAME@$WINDOWS_HOST 'cmd /c $SCRIPT_STATUS'"
      
                }
            }
        }
    
    }
}
